
```{r}
library("dplyr")
library("tidyr")
library("ggplot2")
```


```{r}
hprc_wo_hapmap_hg005_gc <- read.table("hprc_wo_hapmap_hg005_gc.processed.tsv", header=TRUE, sep="\t")

```


# hprc_wo_hapmap_hg005_gc

```{r}
# for column h1_h2 through h3_h4, generate a table of the bitwise flags
lapply(hprc_wo_hapmap_hg005_gc[,6:11], function(x) data.frame(table(x))) %>% bind_rows()->hprc_wo_hapmap_hg005_gc_Flag_Freq

# Add column names
lapply(colnames(hprc_wo_hapmap_hg005_gc[,6:11]), function(X) rep(X,4)) %>% unlist()->hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison

# change "x" column to "Flag"
colnames(hprc_wo_hapmap_hg005_gc_Flag_Freq)<-c("Flag", "Freq", "Comparison")

# Create column where Flags are converted to interpretable values
hprc_wo_hapmap_hg005_gc_Flag_Freq$FlagInterpretation<-factor(hprc_wo_hapmap_hg005_gc_Flag_Freq$Flag, levels=c("0", "2", "1", "3"), labels=c("Missing in both","Missing in one","Same","Different"), ordered=TRUE)

# Replace h1, h2, h3, h4 with Mat, Pat, Rec1, Rec2
hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison<-gsub("h1", "Mat", hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison)
hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison<-gsub("h2", "Pat", hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison)
hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison<-gsub("h3", "Rec1", hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison)
hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison<-gsub("h4", "Rec2", hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison)

# Replace "_" with "~"
hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison<-gsub("_", "~", hprc_wo_hapmap_hg005_gc_Flag_Freq$Comparison)
```

```{r}
ggplot(hprc_wo_hapmap_hg005_gc_Flag_Freq, aes(x=Comparison, y=Freq/1000000, fill=FlagInterpretation))+
  geom_bar(stat="identity", position="dodge")+
  # CS.THEME+
  # scale_fill_viridis(discrete=TRUE)+
  labs(title="hprc_wo_hapmap_hg005_gc",
       x="Comparison",
       y="Frequency (M)",
       fill="Genotype comparison")+
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5), legend.position="bottom")+
  # legend size
  theme(legend.text = element_text(size = 8), legend.title = element_text(size = 8))+
  scale_y_continuous(labels = scales::comma)
```


```{r}
# Merge data
hprc_wo_hapmap_hg005_gc_Flag_Freq$Dataset<-"hprc_wo_hapmap_hg005_gc"

# Combine data
rbind(hprc_wo_hapmap_hg005_gc_Flag_Freq)->Combined_Flag_Freq
```

```{r}
ggplot(Combined_Flag_Freq, aes(x=Comparison, y=Freq/1000000, fill=FlagInterpretation))+
  geom_bar(stat="identity", position="dodge")+
  # CS.THEME+
  # scale_fill_viridis(discrete=TRUE)+
  labs(title="true versus recombinant haplotypes",
       x="Comparison",
       y="Frequency (M)",
       fill="Genotype comparison")+
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5), legend.position="bottom")+
  # legend size
  theme(legend.text = element_text(size = 8), legend.title = element_text(size = 8))+
  scale_y_continuous(labels = scales::comma)+
  facet_grid(Dataset~.)
```

```{r}
# For HG005_simu_R2_chm13_clipped, assume:
# - h1_h3: Mat vs Rec1
# - h2_h3: Pat vs Rec1
# - h1_h4: Mat vs Rec2
# - h2_h4: Pat vs Rec2
# - h1_h2: Mat vs Pat (used to check for missing truth set alleles)
#
# For each parent's allele in each recombinant, if the truth set (Mat vs Pat) 
# has missing data (flag "0" or "2"), then we assign "Missing".
# Otherwise, we mark as "Captured" if the parent's comparison equals "1",
# and "Not captured" otherwise.

```


```{r}
hprc_wo_hapmap_hg005_gc$Mat_truth <- ifelse(
  hprc_wo_hapmap_hg005_gc$h1_h2 %in% c("0", "2"),
  "Missing",
  ifelse(hprc_wo_hapmap_hg005_gc$h1_h3 == "1" | hprc_wo_hapmap_hg005_gc$h1_h4 == "1", "Captured", "Not captured")
)

hprc_wo_hapmap_hg005_gc$Pat_truth <- ifelse(
  hprc_wo_hapmap_hg005_gc$h1_h2 %in% c("0", "2"),
  "Missing",
  ifelse(hprc_wo_hapmap_hg005_gc$h2_h3 == "1" | hprc_wo_hapmap_hg005_gc$h2_h4 == "1", "Captured", "Not captured")
)
```

```{r}
# Transform the data from wide to long format
hprc_wo_hapmap_hg005_gc_truth_long <- hprc_wo_hapmap_hg005_gc %>%
  dplyr::select(Mat_truth, Pat_truth) %>%
  pivot_longer(cols = everything(), names_to = "Parent", values_to = "Status") %>%
  group_by(Parent, Status) %>%
  summarise(Count = n(), .groups="drop") %>%
  group_by(Parent) %>%
  mutate(Percent = Count/sum(Count)*100)

# Print the summary data (optional)
print(hprc_wo_hapmap_hg005_gc_truth_long)
```

```{r}
# Transform the data from wide to long format per chromosome
hprc_wo_hapmap_hg005_gc_truth_full_long_chr <- hprc_wo_hapmap_hg005_gc %>%
  dplyr::select(Mat_truth, Pat_truth, CHROM) %>%
  pivot_longer(cols = c(Mat_truth, Pat_truth), names_to = "Parent", values_to = "Status") %>%
  group_by(CHROM, Parent, Status) %>%
  summarise(Count = n(), .groups="drop") %>%
  group_by(CHROM, Parent) %>%
  mutate(Percent = Count/sum(Count)*100)

# Print the summary data (optional)
print(hprc_wo_hapmap_hg005_gc_truth_full_long_chr)
```

```{r}
# filter out non primary chromosomes (chr1, chr2, ..., chr22, chrX, chrY)
hprc_wo_hapmap_hg005_gc_truth_full_long_chr<-hprc_wo_hapmap_hg005_gc_truth_full_long_chr %>% filter(CHROM %in% c(paste0("chr",1:22)))

# order chromosomes
hprc_wo_hapmap_hg005_gc_truth_full_long_chr$CHROM<-factor(hprc_wo_hapmap_hg005_gc_truth_full_long_chr$CHROM, levels=c(paste0("chr",1:22)))
```

```{r}
# plot truth set allele capture for COLO829BL_R2_chm13_clipped_20x per chromosome, with each chromosome as X-axis and percentage as Y-axis
ggplot(hprc_wo_hapmap_hg005_gc_truth_full_long_chr, aes(x = CHROM, y = Percent, fill = Status)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Truth Set Allele Capture per Chromosome",
       y = "Percentage (%)",
       x = "Chromosome",
       fill = "Status") +
  scale_x_discrete(expand = c(0,0)) +
  # CS.THEME +
  # scale_fill_viridis(discrete = TRUE, option="cividis")+
  facet_grid(Parent~.)+
  # rotate x-axis labels
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```


```{r}
# Merge data
hprc_wo_hapmap_hg005_gc_truth_long$Dataset<-"hprc\n_wo_hapmap\n_hg005_\ngc"

# Combine data
rbind(hprc_wo_hapmap_hg005_gc_truth_long)->Combined_truth_long
```

```{r}
ggplot(Combined_truth_long, aes(y = Parent, x = Percent, fill = Status)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Truth Set Allele Capture",
       y = "Parent",
       x = "Percentage (%)") +
  scale_x_continuous(labels = scales::percent_format(scale = 1), expand = c(0,0)) +
  # CS.THEME +
  # scale_fill_viridis(discrete = TRUE, option="cividis")+
  facet_grid(Dataset~.)
```

